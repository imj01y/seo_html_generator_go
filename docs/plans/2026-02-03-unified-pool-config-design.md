# ç»Ÿä¸€å¯¹è±¡æ± é…ç½®è®¾è®¡æ–¹æ¡ˆ

> æ—¥æœŸï¼š2026-02-03

## æ¦‚è¿°

å°†æ ‡é¢˜æ± ã€clsç±»åæ± ã€urlæ± ã€å…³é”®è¯è¡¨æƒ…æ± çš„é…ç½®ç»Ÿä¸€åŒ–ï¼Œæ¯ä¸ªæ± æ”¯æŒç›¸åŒçš„ 4 ä¸ªé…ç½®é¡¹ï¼Œå¹¶é€šè¿‡ä¸‹æ‹‰èœå•é€‰æ‹©æ± ç±»å‹è¿›è¡Œé…ç½®ï¼Œç®€åŒ–å‰ç«¯é¡µé¢ã€‚

## éœ€æ±‚

1. 4 ä¸ªå¯¹è±¡æ± ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®ç»“æ„ï¼šæ± å¤§å°ã€ç”Ÿæˆåç¨‹æ•°ã€ç”Ÿæˆé—´éš”ã€è¡¥å……é˜ˆå€¼
2. å‰ç«¯ä½¿ç”¨ä¸‹æ‹‰èœå•é€‰æ‹©è¦é…ç½®çš„æ± ï¼Œè€Œéæ¯ä¸ªæ± å•ç‹¬ä¸€ä¸ªé…ç½®å¡ç‰‡
3. æ­£æ–‡æ± ä¿æŒç°æœ‰æ–¹å¼ï¼ˆä»æ•°æ®åº“åŠ è½½ï¼‰ï¼Œä¸çº³å…¥ç»Ÿä¸€é…ç½®
4. è¡¥å……é€»è¾‘æ”¹ä¸º"ä½äºé˜ˆå€¼æ—¶è¡¥å……åˆ°æ»¡"

## è®¾è®¡å†³ç­–

| å†³ç­–ç‚¹ | é€‰æ‹© | ç†ç”± |
|--------|------|------|
| æ­£æ–‡æ±  | ä¿æŒæ•°æ®åº“åŠ è½½ | æ­£æ–‡å†…å®¹é•¿ï¼Œå†…å­˜å ç”¨å¤§ï¼ˆ5000æ¡çº¦25MBï¼‰ |
| è¡¥å……ç­–ç•¥ | è¡¥å……åˆ°æ»¡ | ç®€åŒ–é…ç½®ï¼Œç§»é™¤ RefillBatch å‚æ•° |
| é…ç½®é¡¹æ•°é‡ | 4 ä¸ª | æ± å¤§å°ã€åç¨‹æ•°ã€é—´éš”ã€é˜ˆå€¼ |
| å‰ç«¯äº¤äº’ | ä¸‹æ‹‰é€‰æ‹©æ±  | é¡µé¢æ›´ç®€æ´ç´§å‡‘ |

## é…ç½®èŒƒå›´

**çº³å…¥ç»Ÿä¸€é…ç½®çš„æ± ï¼ˆ4ä¸ªï¼‰ï¼š**
- æ ‡é¢˜æ± 
- clsç±»åæ± 
- urlæ± 
- å…³é”®è¯è¡¨æƒ…æ± 

**ä¸çº³å…¥çš„æ± ï¼š**
- æ­£æ–‡æ± ï¼ˆä¿æŒç°æœ‰é…ç½®æ–¹å¼ï¼‰

## ç°æœ‰ç”Ÿæˆé€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰

### clsç±»åæ± 
```
ç”Ÿæˆæ ¼å¼ï¼š13ä½éšæœºå­—ç¬¦ + ç©ºæ ¼ + 32ä½éšæœºå­—ç¬¦
å­—ç¬¦é›†ï¼šabcdefghijklmnopqrstuvwxyz0123456789
ç¤ºä¾‹ï¼šab3kz9x2m1pqr 7h2jk9d0f3s5t8w1q4e6r2y7u0p3a5l
```

### urlæ± 
```
60% æ¦‚ç‡ï¼š/?{9ä½æ•°å­—}.html
40% æ¦‚ç‡ï¼š/?{æ—¥æœŸ}/{5ä½æ•°å­—}.html
ç¤ºä¾‹ï¼š/?123456789.html æˆ– /?20260203/12345.html
```

### å…³é”®è¯è¡¨æƒ…æ± 
```
1. ä»åŸå§‹å…³é”®è¯ä¸­å–ä¸€ä¸ª
2. 50% æ¦‚ç‡æ’å…¥ 1 ä¸ª emojiï¼Œ50% æ¦‚ç‡æ’å…¥ 2 ä¸ª emoji
3. åœ¨å…³é”®è¯çš„éšæœºä½ç½®æ’å…¥
4. HTML å®ä½“ç¼–ç è¾“å‡º
ç¤ºä¾‹ï¼šå…³ğŸ˜€é”®è¯ æˆ– å…³ğŸ˜€é”®ğŸ‰è¯
```

### æ ‡é¢˜æ± 
```
æ ¼å¼ï¼šå…³é”®è¯1 + emoji1 + å…³é”®è¯2 + emoji2 + å…³é”®è¯3
ä»å…³é”®è¯æ± éšæœºå– 3 ä¸ªï¼Œä» emoji åº“éšæœºå– 2 ä¸ªä¸é‡å¤çš„
```

## æ•°æ®åº“è®¾è®¡

**pool_config è¡¨æ–°å¢å­—æ®µï¼š**

```sql
-- æ ‡é¢˜æ± ï¼ˆå·²æœ‰å­—æ®µï¼Œä¿æŒï¼‰
title_pool_size          INT DEFAULT 800000
title_workers            INT DEFAULT 20
title_refill_interval_ms INT DEFAULT 30
title_threshold          DECIMAL(3,2) DEFAULT 0.40

-- clsç±»åæ± ï¼ˆæ–°å¢ï¼‰
cls_pool_size            INT DEFAULT 800000
cls_workers              INT DEFAULT 20
cls_refill_interval_ms   INT DEFAULT 30
cls_threshold            DECIMAL(3,2) DEFAULT 0.40

-- urlæ± ï¼ˆæ–°å¢ï¼‰
url_pool_size            INT DEFAULT 500000
url_workers              INT DEFAULT 16
url_refill_interval_ms   INT DEFAULT 30
url_threshold            DECIMAL(3,2) DEFAULT 0.40

-- å…³é”®è¯è¡¨æƒ…æ± ï¼ˆæ–°å¢ï¼‰
keyword_emoji_pool_size          INT DEFAULT 800000
keyword_emoji_workers            INT DEFAULT 20
keyword_emoji_refill_interval_ms INT DEFAULT 30
keyword_emoji_threshold          DECIMAL(3,2) DEFAULT 0.40
```

## åç«¯æ”¹åŠ¨

### 1. pool_config.go - æ‰©å±•é…ç½®ç»“æ„

```go
type CachePoolConfig struct {
    // æ­£æ–‡æ± ï¼ˆä¿æŒç°æœ‰ï¼‰
    ContentsSize     int `db:"contents_size" json:"contents_size"`
    Threshold        int `db:"threshold" json:"threshold"`
    RefillIntervalMs int `db:"refill_interval_ms" json:"refill_interval_ms"`

    // æ ‡é¢˜æ± 
    TitlePoolSize         int     `db:"title_pool_size" json:"title_pool_size"`
    TitleWorkers          int     `db:"title_workers" json:"title_workers"`
    TitleRefillIntervalMs int     `db:"title_refill_interval_ms" json:"title_refill_interval_ms"`
    TitleThreshold        float64 `db:"title_threshold" json:"title_threshold"`

    // clsç±»åæ± 
    ClsPoolSize         int     `db:"cls_pool_size" json:"cls_pool_size"`
    ClsWorkers          int     `db:"cls_workers" json:"cls_workers"`
    ClsRefillIntervalMs int     `db:"cls_refill_interval_ms" json:"cls_refill_interval_ms"`
    ClsThreshold        float64 `db:"cls_threshold" json:"cls_threshold"`

    // urlæ± 
    UrlPoolSize         int     `db:"url_pool_size" json:"url_pool_size"`
    UrlWorkers          int     `db:"url_workers" json:"url_workers"`
    UrlRefillIntervalMs int     `db:"url_refill_interval_ms" json:"url_refill_interval_ms"`
    UrlThreshold        float64 `db:"url_threshold" json:"url_threshold"`

    // å…³é”®è¯è¡¨æƒ…æ± 
    KeywordEmojiPoolSize         int     `db:"keyword_emoji_pool_size" json:"keyword_emoji_pool_size"`
    KeywordEmojiWorkers          int     `db:"keyword_emoji_workers" json:"keyword_emoji_workers"`
    KeywordEmojiRefillIntervalMs int     `db:"keyword_emoji_refill_interval_ms" json:"keyword_emoji_refill_interval_ms"`
    KeywordEmojiThreshold        float64 `db:"keyword_emoji_threshold" json:"keyword_emoji_threshold"`
}
```

### 2. object_pool.go - ä¿®æ”¹è¡¥å……é€»è¾‘

å°† `LowWatermark` æ”¹ä¸º `Threshold`ï¼Œè¡¥å……é€»è¾‘æ”¹ä¸º"è¡¥å……åˆ°æ»¡"ï¼š

```go
type PoolConfig struct {
    Name          string
    Size          int
    Threshold     float64       // ä½äºæ­¤æ¯”ä¾‹è§¦å‘è¡¥å……
    NumWorkers    int
    CheckInterval time.Duration
}

// checkAndRefill æ£€æŸ¥å¹¶è¡¥å……åˆ°æ»¡
func (p *ObjectPool[T]) checkAndRefill() {
    if p.paused.Load() {
        return
    }

    available := p.Available()
    threshold := int64(float64(p.size) * p.threshold)

    if available < threshold {
        // è¡¥å……åˆ°æ»¡
        need := p.size - available
        p.refillToFull(need)
    }
}
```

### 3. template_funcs.go - ä»é…ç½®åˆå§‹åŒ–æ± 

```go
func (m *TemplateFuncsManager) InitPools(config *CachePoolConfig) {
    m.clsPool = NewObjectPool[string](PoolConfig{
        Name:          "cls",
        Size:          config.ClsPoolSize,
        Threshold:     config.ClsThreshold,
        NumWorkers:    config.ClsWorkers,
        CheckInterval: time.Duration(config.ClsRefillIntervalMs) * time.Millisecond,
    }, generateRandomCls)

    m.urlPool = NewObjectPool[string](PoolConfig{
        Name:          "url",
        Size:          config.UrlPoolSize,
        Threshold:     config.UrlThreshold,
        NumWorkers:    config.UrlWorkers,
        CheckInterval: time.Duration(config.UrlRefillIntervalMs) * time.Millisecond,
    }, generateRandomURL)

    m.keywordEmojiPool = NewObjectPool[string](PoolConfig{
        Name:          "keyword_emoji",
        Size:          config.KeywordEmojiPoolSize,
        Threshold:     config.KeywordEmojiThreshold,
        NumWorkers:    config.KeywordEmojiWorkers,
        CheckInterval: time.Duration(config.KeywordEmojiRefillIntervalMs) * time.Millisecond,
    }, m.generateKeywordWithEmoji)
}
```

### 4. title_generator.go - ä½¿ç”¨ç»Ÿä¸€é…ç½®

TitleGenerator ä¹Ÿä½¿ç”¨ç›¸åŒçš„é…ç½®ç»“æ„ï¼Œä» CachePoolConfig è¯»å–æ ‡é¢˜æ± é…ç½®ã€‚

## å‰ç«¯æ”¹åŠ¨

### 1. cache-pool.ts - æ›´æ–°ç±»å‹å®šä¹‰

```typescript
interface PoolItemConfig {
  pool_size: number
  workers: number
  refill_interval_ms: number
  threshold: number  // 0-1 çš„å°æ•°
}

interface CachePoolConfig {
  // æ­£æ–‡æ± ï¼ˆä¿æŒç°æœ‰ï¼‰
  contents_size: number
  threshold: number
  refill_interval_ms: number

  // å¯¹è±¡æ± é…ç½®
  title_pool_size: number
  title_workers: number
  title_refill_interval_ms: number
  title_threshold: number

  cls_pool_size: number
  cls_workers: number
  cls_refill_interval_ms: number
  cls_threshold: number

  url_pool_size: number
  url_workers: number
  url_refill_interval_ms: number
  url_threshold: number

  keyword_emoji_pool_size: number
  keyword_emoji_workers: number
  keyword_emoji_refill_interval_ms: number
  keyword_emoji_threshold: number
}
```

### 2. CacheManage.vue - æ•°æ®æ± é…ç½® tab

**å¸ƒå±€ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®æ± é…ç½®                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ­£æ–‡æ±          â”‚  â”‚  â”‚ å¯¹è±¡æ± é…ç½®             â”‚ â”‚
â”‚  â”‚                â”‚  â”‚  â”‚                        â”‚ â”‚
â”‚  â”‚ æ­£æ–‡æ± å¤§å° [ ] â”‚  â”‚  â”‚ é€‰æ‹©æ±  [â–¼ æ ‡é¢˜æ±     ] â”‚ â”‚
â”‚  â”‚ è¡¥å……é˜ˆå€¼   [ ] â”‚  â”‚  â”‚                        â”‚ â”‚
â”‚  â”‚ æ£€æŸ¥é—´éš”   [ ] â”‚  â”‚  â”‚ æ± å¤§å°     [        ] â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ ç”Ÿæˆåç¨‹æ•° [        ] â”‚ â”‚
â”‚                      â”‚  â”‚ ç”Ÿæˆé—´éš”   [        ] â”‚ â”‚
â”‚                      â”‚  â”‚ è¡¥å……é˜ˆå€¼   [        ] â”‚ â”‚
â”‚                      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    [ä¿å­˜é…ç½®]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸‹æ‹‰èœå•é€‰é¡¹ï¼š**
- æ ‡é¢˜æ± 
- clsç±»åæ± 
- urlæ± 
- å…³é”®è¯è¡¨æƒ…æ± 

**äº¤äº’é€»è¾‘ï¼š**
- åˆ‡æ¢ä¸‹æ‹‰èœå•æ—¶ï¼Œæ˜¾ç¤ºå¯¹åº”æ± çš„å½“å‰é…ç½®å€¼
- ä¿®æ”¹åç‚¹å‡»ä¿å­˜ï¼Œæ›´æ–°æ‰€é€‰æ± çš„é…ç½®

## æ–‡ä»¶å˜æ›´æ¸…å•

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `api/internal/service/pool_config.go` | ä¿®æ”¹ | æ‰©å±•é…ç½®ç»“æ„ï¼Œæ·»åŠ  12 ä¸ªæ–°å­—æ®µ |
| `api/internal/service/object_pool.go` | ä¿®æ”¹ | è¡¥å……é€»è¾‘æ”¹ä¸º"è¡¥å……åˆ°æ»¡" |
| `api/internal/service/template_funcs.go` | ä¿®æ”¹ | InitPools ä»é…ç½®è¯»å–å‚æ•° |
| `api/internal/service/title_generator.go` | ä¿®æ”¹ | ä½¿ç”¨ç»Ÿä¸€é…ç½®ç»“æ„ |
| `api/internal/handler/pool.go` | ä¿®æ”¹ | API æ”¯æŒæ–°å­—æ®µ |
| `web/src/api/cache-pool.ts` | ä¿®æ”¹ | æ›´æ–°ç±»å‹å®šä¹‰ |
| `web/src/views/cache/CacheManage.vue` | ä¿®æ”¹ | ä¸‹æ‹‰é€‰æ‹©æ±  + ç»Ÿä¸€é…ç½®è¡¨å• |
| `migrations/002_unified_pool_config.sql` | æ–°å¢ | æ•°æ®åº“è¿ç§» |

## é»˜è®¤é…ç½®å€¼

| æ±  | æ± å¤§å° | åç¨‹æ•° | é—´éš”(ms) | é˜ˆå€¼ |
|---|---|---|---|---|
| æ ‡é¢˜æ±  | 800,000 | 20 | 30 | 0.4 |
| clsç±»åæ±  | 800,000 | 20 | 30 | 0.4 |
| urlæ±  | 500,000 | 16 | 30 | 0.4 |
| å…³é”®è¯è¡¨æƒ…æ±  | 800,000 | 20 | 30 | 0.4 |
