# ==============================================
# SEO HTML Generator - 多站点配置模板
# ==============================================
# 使用说明:
# 1. 复制此文件并重命名为 your-domain.conf
# 2. 将 example.com 替换为实际域名
# 3. 重启 nginx: docker-compose restart nginx
# ==============================================

server {
    listen 80;
    listen [::]:80;
    server_name example.com www.example.com;

    # 日志 (按站点分离)
    access_log /var/log/nginx/example.com.access.log detailed;
    error_log /var/log/nginx/example.com.error.log warn;

    # 根目录
    root /app;

    # 字符编码
    charset utf-8;

    # 客户端请求限制
    client_max_body_size 50M;

    # ==========================================
    # 健康检查
    # ==========================================
    location = /nginx-health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # ==========================================
    # API 反向代理
    # ==========================================
    location /api/ {
        proxy_pass http://fastapi_backend;
        proxy_http_version 1.1;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Spider $is_spider;
        proxy_set_header Connection "";
    }

    # ==========================================
    # 静态资源
    # ==========================================
    location /static {
        alias /app/static;
        expires 7d;
        add_header Cache-Control "public";
    }

    location = /favicon.ico {
        alias /app/static/favicon.ico;
        access_log off;
        log_not_found off;
    }

    location = /robots.txt {
        alias /app/static/robots.txt;
        access_log off;
        log_not_found off;
    }

    # ==========================================
    # HTML 缓存直服
    # ==========================================
    location / {
        set $normalized_path $uri;

        if ($uri = /) {
            set $normalized_path /index.html;
        }

        if ($uri ~ "^/[^.]+$") {
            set $normalized_path $uri.html;
        }

        root /app/html_cache;
        try_files /$host$normalized_path @fastapi_backend;

        add_header X-Cache-Status "HIT" always;
        add_header X-Served-By "nginx-cache" always;
        expires 1h;
    }

    # ==========================================
    # FastAPI 回源
    # ==========================================
    location @fastapi_backend {
        proxy_pass http://fastapi_backend;
        proxy_http_version 1.1;
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Spider $is_spider;
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header Connection "";
        add_header X-Cache-Status "MISS" always;
        add_header X-Served-By "fastapi-backend" always;
    }
}
